var Pomelo=function(q){function r(a){if(a)return H(a)}function H(a){for(var c in r.prototype)a[c]=r.prototype[c];return a}function B(a,c){if(!c)return!1;for(var b in c){var d=c[b];switch(d.option){case "required":if("undefined"===typeof a[b])return!1;break;case "optional":"undefined"!==typeof a[b]&&c.__messages[d.type]&&B(a[b],c.__messages[d.type]);break;case "repeated":if(a[b]&&c.__messages[d.type])for(var e=0;e<a[b].length;e++)if(!B(a[b][e],c.__messages[d.type]))return!1}}return!0}function I(a,
c,b,d){for(var e in d)if(b[e]){var f=b[e];switch(f.option){case "required":case "optional":c=t(a,c,C(f.type,f.tag));c=D(d[e],f.type,c,a,b);break;case "repeated":if(0<d[e].length){var y=d[e],n=a,h=b,g;if(util.isSimpleType(f.type))for(c=t(n,c,C(f.type,f.tag)),c=t(n,c,k.codec.encodeUInt32(y.length)),g=0;g<y.length;g++)c=D(y[g],f.type,c,n);else for(g=0;g<y.length;g++)c=t(n,c,C(f.type,f.tag)),c=D(y[g],f.type,c,n,h)}}}return c}function D(a,c,b,d,e){var f=k.codec;switch(c){case "uInt32":b=t(d,b,f.encodeUInt32(a));
break;case "int32":case "sInt32":b=t(d,b,f.encodeSInt32(a));break;case "float":t(d,b,f.encodeFloat(a));b+=4;break;case "double":t(d,b,f.encodeDouble(a));b+=8;break;case "string":c=f.byteLength(a);b=t(d,b,f.encodeUInt32(c));f.encodeStr(d,b,a);b+=c;break;default:if(e.__messages[c]){var g=new ArrayBuffer(f.byteLength(JSON.stringify(a)));c=I(g,0,e.__messages[c],a);b=t(d,b,f.encodeUInt32(c));for(a=0;a<c;a++)d[b]=g[a],b++}}return b}function t(a,c,b){for(var d=0;d<b.length;d++,c++)a[c]=b[d];return c}function C(a,
c){return k.codec.encodeUInt32(c<<3|(k.constants.TYPES[a]||2))}function J(a,c,b){for(var d;h.offset<b;){d=k.codec.decodeUInt32(x())>>3;var e=c.__tags[d];switch(c[e].option){case "optional":case "required":a[e]=E(c[e].type,c);break;case "repeated":a[e]||(a[e]=[]);d=a[e];var e=c[e].type,f=c;if(O.isSimpleType(e))for(var f=k.codec.decodeUInt32(x()),g=0;g<f;g++)d.push(E(e));else d.push(E(e,f))}}return a}function E(a,c){var b=k.codec;switch(a){case "uInt32":return b.decodeUInt32(x());case "int32":case "sInt32":return b.decodeSInt32(x());
case "float":var d=b.decodeFloat(h.buffer,h.offset);h.offset+=4;return d;case "double":return d=b.decodeDouble(h.buffer,h.offset),h.offset+=8,d;case "string":return d=b.decodeUInt32(x()),a=b.decodeStr(h.buffer,h.offset,d),h.offset+=d,a;default:if(c&&c.__messages[a])return d=b.decodeUInt32(x()),b={},J(b,c.__messages[a],h.offset+d),b}}function x(a){var c=[],b=h.offset;a=a||!1;var d;do d=z[b],c.push(d),b++;while(128<=d);a||(h.offset=b);return c}var K;K=egret.Capabilities.runtimeType==egret.RuntimeType.NATIVE?
__global.egret_native.WebSocket:window.WebSocket;r.prototype.on=function(a,c){this._callbacks=this._callbacks||{};(this._callbacks[a]=this._callbacks[a]||[]).push(c);return this};r.prototype.once=function(a,c){function b(){d.off(a,b);c.apply(this,arguments)}var d=this;this._callbacks=this._callbacks||{};c._off=b;this.on(a,b);return this};r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=function(a,c){this._callbacks=this._callbacks||{};if(0==arguments.length)return this._callbacks=
{},this;var b=this._callbacks[a];if(!b)return this;if(1==arguments.length)return delete this._callbacks[a],this;var d=index(b,c._off||c);~d&&b.splice(d,1);return this};r.prototype.emit=function(a){this._callbacks=this._callbacks||{};var c=[].slice.call(arguments,1),b=this._callbacks[a];if(b)for(var b=b.slice(0),d=0,e=b.length;d<e;++d)b[d].apply(this,c);return this};r.prototype.listeners=function(a){this._callbacks=this._callbacks||{};return this._callbacks[a]||[]};r.prototype.hasListeners=function(a){return!!this.listeners(a).length};
var u={Package:{TYPE_HANDSHAKE:1,TYPE_HANDSHAKE_ACK:2,TYPE_HEARTBEAT:3,TYPE_DATA:4,TYPE_KICK:5},Message:{TYPE_REQUEST:0,TYPE_NOTIFY:1,TYPE_RESPONSE:2,TYPE_PUSH:3}},l=u.Package,m=u.Message;u.strencode=function(a){for(var c=new q(3*a.length),b=0,d=0;d<a.length;d++)for(var e=a.charCodeAt(d),e=127>=e?[e]:2047>=e?[192|e>>6,128|e&63]:[224|e>>12,128|(e&4032)>>6,128|e&63],f=0;f<e.length;f++)c[b]=e[f],++b;a=new q(b);w(a,0,c,0,b);return a};u.strdecode=function(a){a=new q(a);for(var c=[],b=0,d,e=a.length;b<
e;)128>a[b]?(d=a[b],b+=1):224>a[b]?(d=((a[b]&63)<<6)+(a[b+1]&63),b+=2):(d=((a[b]&15)<<12)+((a[b+1]&63)<<6)+(a[b+2]&63),b+=3),c.push(d);return String.fromCharCode.apply(null,c)};l.encode=function(a,c){var b=c?c.length:0,d=new q(4+b),e=0;d[e++]=a&255;d[e++]=b>>16&255;d[e++]=b>>8&255;d[e++]=b&255;c&&w(d,e,c,0,b);return d};l.decode=function(a){a=new q(a);var c=a[0],b=1,d=(b=(a[b++]<<16|a[b++]<<8|a[b++])>>>0)?new q(b):null;w(d,0,a,4,b);return{type:c,body:d}};m.encode=function(a,c,b,d,e){var f;if(F(c)){f=
a;var g=0;do g+=1,f>>=7;while(0<f);f=g}else f=0;g=f;f=1+g;if(G(c))if(b){if("number"!==typeof d)throw Error("error flag for number route!");f+=2}else if(f+=1,d){d=u.strencode(d);if(255<d.length)throw Error("route maxlength is overflow");f+=d.length}e&&(f+=e.length);f=new q(f);var n;if(c!==m.TYPE_REQUEST&&c!==m.TYPE_NOTIFY&&c!==m.TYPE_RESPONSE&&c!==m.TYPE_PUSH)throw Error("unkonw message type: "+c);f[0]=c<<1|(b?1:0);n=1;if(F(c)){var h=n+g-1;for(f[h--]=a&127;h>=n;)a>>=7,f[h--]=a&127|128;n+=g}if(G(c)){c=
d;d=n;if(b){if(65535<c)throw Error("route number is overflow");f[d++]=c>>8&255;f[d++]=c&255}else c?(f[d++]=c.length&255,w(f,d,c,0,c.length),d+=c.length):f[d++]=0;n=d}e&&w(f,n,e,0,e.length);return f};m.decode=function(a){a=new q(a);var c=a.length||a.byteLength,b=0,d=0,e=null,f=a[b++],g=f&1,f=f>>1&7;if(F(f))for(var h=a[b++],d=h&127;h&128;)d<<=7,h=a[b++],d|=h&127;G(f)&&(g?e=a[b++]<<8|a[b++]:((h=a[b++])?(e=new q(h),w(e,0,a,b,h),e=u.strdecode(e)):e="",b+=h));c-=b;h=new q(c);w(h,0,a,b,c);return{id:d,type:f,
compressRoute:g,route:e,body:h}};var w=function(a,c,b,d,e){if("function"===typeof b.copy)b.copy(a,c,d,d+e);else for(var f=0;f<e;f++)a[c++]=b[d++]},F=function(a){return a===m.TYPE_REQUEST||a===m.TYPE_RESPONSE},G=function(a){return a===m.TYPE_REQUEST||a===m.TYPE_NOTIFY||a===m.TYPE_PUSH},k={init:function(a){k.encoder.init(a.encoderProtos);k.decoder.init(a.decoderProtos)},encode:function(a,c){return k.encoder.encode(a,c)},decode:function(a,c){return k.decoder.decode(a,c)}};(k.constants={}).TYPES={uInt32:0,
sInt32:0,int32:0,double:1,string:2,message:2,float:5};var O={isSimpleType:function(a){return"uInt32"===a||"sInt32"===a||"int32"===a||"uInt64"===a||"sInt64"===a||"float"===a||"double"===a}},p=k.codec={},z=new ArrayBuffer(8),L=new Float32Array(z),M=new Float64Array(z),A=new Uint8Array(z);p.encodeUInt32=function(a){a=parseInt(a);if(isNaN(a)||0>a)return null;var c=[];do{var b=a%128;a=Math.floor(a/128);0!==a&&(b+=128);c.push(b)}while(0!==a);return c};p.encodeSInt32=function(a){a=parseInt(a);if(isNaN(a))return null;
a=0>a?2*Math.abs(a)-1:2*a;return p.encodeUInt32(a)};p.decodeUInt32=function(a){for(var c=0,b=0;b<a.length;b++){var d=parseInt(a[b]),c=c+(d&127)*Math.pow(2,7*b);if(128>d)break}return c};p.decodeSInt32=function(a){a=this.decodeUInt32(a);return(a%2+a)/2*(1===a%2?-1:1)};p.encodeFloat=function(a){L[0]=a;return A};p.decodeFloat=function(a,c){if(!a||a.length<c+4)return null;for(var b=0;4>b;b++)A[b]=a[c+b];return L[0]};p.encodeDouble=function(a){M[0]=a;return A.subarray(0,8)};p.decodeDouble=function(a,c){if(!a||
a.length<8+c)return null;for(var b=0;8>b;b++)A[b]=a[c+b];return M[0]};p.encodeStr=function(a,c,b){for(var d=0;d<b.length;d++){var e=b.charCodeAt(d);e=127>=e?[e]:2047>=e?[192|e>>6,128|e&63]:[224|e>>12,128|(e&4032)>>6,128|e&63];for(var f=0;f<e.length;f++)a[c]=e[f],c++}return c};p.decodeStr=function(a,c,b){var d=[];for(b=c+b;c<b;){var e;128>a[c]?(e=a[c],c+=1):224>a[c]?(e=((a[c]&63)<<6)+(a[c+1]&63),c+=2):(e=((a[c]&15)<<12)+((a[c+1]&63)<<6)+(a[c+2]&63),c+=3);d.push(e)}a="";for(c=0;c<d.length;)a+=String.fromCharCode.apply(null,
d.slice(c,c+1E4)),c+=1E4;return a};p.byteLength=function(a){if("string"!==typeof a)return-1;for(var c=0,b=0;b<a.length;b++){var d=a.charCodeAt(b);d=127>=d?1:2047>=d?2:3;c+=d}return c};var N=k.encoder={};N.init=function(a){this.protos=a||{}};N.encode=function(a,c){a=this.protos[a];if(!B(c,a))return null;var b=k.codec.byteLength(JSON.stringify(c)),b=new ArrayBuffer(b),b=new Uint8Array(b);return a&&(c=I(b,0,a,c),0<c)?b.subarray(0,c):null};var h=k.decoder={};h.buffer=0;h.offset=0;h.init=function(a){this.protos=
a||{}};h.setProtos=function(a){a&&(this.protos=a)};h.decode=function(a,c){a=this.protos[a];h.buffer=c;h.offset=0;return a?J({},a,z.length):null};var v=function(){this.socket=null;this.callbacks={};this.handlers={};this.routeMap={};this.nextHeartbeatTimeout=this.heartbeatTimeout=this.heartbeatInterval=0;this.gapThreshold=100;this.handshakeCallback=this.heartbeatTimeoutId=this.heartbeatId=null;this.handshakeBuffer={sys:{type:"js-websocket",version:"0.0.5"},user:{}};this.initCallback=null;this.handlers[l.TYPE_HANDSHAKE]=
this.handshake;this.handlers[l.TYPE_HEARTBEAT]=this.heartbeat;this.handlers[l.TYPE_DATA]=this.onData;this.handlers[l.TYPE_KICK]=this.onKick};v.reqId=120;var g=v.prototype;H(g);g.init=function(a,c,b,d,e,f){this.initCallback=b;this.thisArgs=f;this.errorCallback=d;this.closeCallBack=e;d=a.host;e=a.port;f="ws://"+d;1==c&&(f="wss://"+d);e&&(f+=":"+e);this.handshakeBuffer.user=a.user;this.handshakeCallback=a.handshakeCallback;this.initWebSocket(f,b)};g.initWebSocket=function(a,c){console.log("connect to "+
a);var b=this,d=function(a){a=l.encode(l.TYPE_HANDSHAKE,u.strencode(JSON.stringify(b.handshakeBuffer)));b.send(a)},e=function(a){b.processPackage(l.decode(a.data),c);b.heartbeatTimeout&&(b.nextHeartbeatTimeout=Date.now()+b.heartbeatTimeout)},f=function(a){b.processPackage(l.decode(a),c);b.heartbeatTimeout&&(b.nextHeartbeatTimeout=Date.now()+b.heartbeatTimeout)},g=function(a){b.emit("io-error",a);console.error("socket error: ",a);b.errorCallback&&b.errorCallback.apply(b.thisArgs,a)},h=function(a){b.emit("close",
a);console.error("socket close: ",a);b.closeCallBack&&b.closeCallBack.apply(b.thisArgs,a)};this.socket=new K(a);egret.Capabilities.runtimeType==egret.RuntimeType.NATIVE?(this.socket.onOpen=d,this.socket.onMessage=f,this.socket.onError=g,this.socket.onClose=h):(this.socket.binaryType="arraybuffer",this.socket.onopen=d,this.socket.onmessage=e,this.socket.onerror=g,this.socket.onclose=h)};g.disconnect=function(){var a=this.socket;a&&(a.disconnect&&a.disconnect(),a.close&&a.close(),console.log("disconnect"),
this.socket=null);this.heartbeatId&&(clearTimeout(this.heartbeatId),this.heartbeatId=null);this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null);this.closeCallBack=this.errorCallback=this.thisArgs=this.initCallback=null};g.request=function(a,c,b){2===arguments.length&&"function"===typeof c?(b=c,c={}):c=c||{};if(a=a||c.route)v.reqId++,128==v.reqId&&(v.reqId=1),this.sendMessage(v.reqId,a,c),this.callbacks[v.reqId]=b,this.routeMap[v.reqId]=a};g.notify=function(a,
c){c=c||{};this.sendMessage(0,a,c)};g.sendMessage=function(a,c,b){var d=a?m.TYPE_REQUEST:m.TYPE_NOTIFY;b=(this.data.protos?this.data.protos.client:{})[c]?k.encode(c,b):u.strencode(JSON.stringify(b));var e=0;this.dict&&this.dict[c]&&(c=this.dict[c],e=1);b=m.encode(a,d,e,c,b);a=l.encode(l.TYPE_DATA,b);this.send(a)};g.send=function(a){this.socket.send(a.buffer)};g.heartbeat=function(a){if(this.heartbeatInterval){var c=l.encode(l.TYPE_HEARTBEAT);this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),
this.heartbeatTimeoutId=null);if(!this.heartbeatId){var b=this;this.heartbeatId=setTimeout(function(){b.heartbeatId=null;b.send(c);b.nextHeartbeatTimeout=Date.now()+b.heartbeatTimeout;b.heartbeatTimeoutId=setTimeout(b.heartbeatTimeoutCb.bind(b),b.heartbeatTimeout)},this.heartbeatInterval)}}};g.heartbeatTimeoutCb=function(){var a=this.nextHeartbeatTimeout-Date.now();a>this.gapThreshold?this.heartbeatTimeoutId=setTimeout(this.heartbeatTimeoutCb.bind(this),a):(console.error("server heartbeat timeout"),
this.emit("heartbeat_timeout"),this.disconnect())};g.handshake=function(a){a=JSON.parse(u.strdecode(a));if(501===a.code)this.emit("error","client version not fullfill");else if(200!==a.code)this.emit("error","handshake fail");else{this.handshakeInit(a);var c=l.encode(l.TYPE_HANDSHAKE_ACK);this.send(c);this.initCallback&&(this.initCallback.apply(this.thisArgs,a),this.initCallback=null)}};g.onData=function(a){a=m.decode(a);if(0<a.id&&(a.route=this.routeMap[a.id],delete this.routeMap[a.id],!a.route))return;
a.body=this.deCompose(a);this.processMessage(g,a)};g.onKick=function(a){this.emit("onKick")};g.processPackage=function(a){this.handlers[a.type].apply(this,[a.body])};g.processMessage=function(a,c){c.id?(a=this.callbacks[c.id],delete this.callbacks[c.id],"function"===typeof a&&a(c.body)):this.emit("server_push_message",c)};g.deCompose=function(a){var c=this.data.protos?this.data.protos.server:{},b=this.data.abbrs,d=a.route;if(a.compressRoute){if(!b[d])return{};d=a.route=b[d]}return c[d]?k.decode(d,
a.body):JSON.parse(u.strdecode(a.body))};g.handshakeInit=function(a){a.sys&&a.sys.heartbeat?(this.heartbeatInterval=1E3*a.sys.heartbeat,this.heartbeatTimeout=2*this.heartbeatInterval):this.heartbeatTimeout=this.heartbeatInterval=0;this.initData(a);"function"===typeof this.handshakeCallback&&this.handshakeCallback(a.user)};g.initData=function(a){if(a&&a.sys){this.data=a||{};var c=a.sys.dict,b=a.sys.protos;if(c){a.dict=c;a.abbrs={};for(var d in c)a.abbrs[c[d]]=d}b&&(a.protos={server:b.server||{},client:b.client||
{}},k&&k.init({encoderProtos:b.client,decoderProtos:b.server}))}};return v}(Uint8Array);